<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>스포일러 컨텍스트 메뉴 테스트</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            padding: 16px;
            background-color: #f9f9f9;
        }

        h1 {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }
        
        p.instructions {
            font-size: 0.9rem;
            color: #555;
            margin-top: 0;
            line-height: 1.5;
        }

        /* 텍스트 편집 영역 */
        #text-editor {
            width: 100%;
            min-height: 300px; /* 영역을 넓게 */
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #fff;
            box-sizing: border-box;
            font-size: 1rem;
            line-height: 1.6;
            -webkit-user-select: text;
            user-select: text;
        }

        /* * 스포일러 처리된 텍스트 (span) 스타일 
         * 스크린리더가 읽지 못하게 시각적으로만 처리
         */
        .spoiler-mask {
            background-color: #d0d0d0; /* 회색 배경 */
            color: #d0d0d0;           /* 텍스트 색상도 배경과 동일하게 */
            border-radius: 4px;
            padding: 0 2px;
            /* 더블탭 시 텍스트가 선택되는 것을 방지 */
            -webkit-user-select: none;
            user-select: none;
        }

        /* * 텍스트 블럭 지정 시 나타나는 컨텍스트 메뉴 
         */
        #context-menu {
            display: none; /* 평소에는 숨김 */
            position: absolute; /* 화면 기준으로 위치 지정 */
            background-color: #333;
            border-radius: 6px;
            padding: 4px;
            z-index: 100;
            /* 중앙 정렬 및 위쪽 배치를 위한 transform */
            transform: translate(-50%, -110%);
            -webkit-tap-highlight-color: transparent;
        }

        #spoiler-button {
            background: none;
            border: none;
            color: white;
            font-size: 0.9rem;
            font-weight: 500;
            padding: 8px 12px;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <h1>스포일러 마스킹 테스트 (V2)</h1>
    <p class="instructions">
        1. 아래 영역에 텍스트를 입력하세요.<br>
        2. 숨기고 싶은 텍스트를 드래그한 후 <strong>손가락을 떼보세요.</strong><br>
        3. 나타나는 <strong>[스포방지]</strong> 버튼을 누르세요.<br>
        4. 회색 영역을 <strong>더블탭(두 번 터치)</strong>하면 해제됩니다.<br>
        5. (테스트) VoiceOver/TalkBack을 켜고 회색 영역을 터치해보세요.
    </p>

    <div id="text-editor" contenteditable="true" spellcheck="false">
        <p>이곳에 텍스트를 입력하세요.</p>
        <p>범인은 바로... (이 뒷부분을 드래그하고 손을 떼보세요)</p>
    </div>

    <div id="context-menu">
        <button id="spoiler-button">스포방지</button>
    </div>

    <script>
        const editor = document.getElementById('text-editor');
        const contextMenu = document.getElementById('context-menu');
        const spoilerButton = document.getElementById('spoiler-button');

        // 현재 사용자가 선택한 텍스트의 '범위(Range)'를 저장할 변수
        let currentSelectionRange = null;

        // --- 1. 텍스트 선택 완료 시 (손가락을 뗄 때) 메뉴 표시 ---
        editor.addEventListener('touchend', () => {
            // selection 상태가 확정될 때까지 잠시 대기 (50ms)
            setTimeout(() => {
                const selection = window.getSelection();

                // 1-1. 텍스트가 실제로 '선택'되었을 때 (커서만 깜빡이는 게 아닐 때)
                if (selection && !selection.isCollapsed && selection.rangeCount > 0) {
                    // 선택한 범위를 저장
                    currentSelectionRange = selection.getRangeAt(0).cloneRange();
                    
                    // 선택한 영역의 위치 정보를 가져옴
                    const rect = currentSelectionRange.getBoundingClientRect();

                    // 메뉴 위치 설정 (선택 영역의 중간 위쪽)
                    contextMenu.style.top = `${rect.top}px`;
                    contextMenu.style.left = `${rect.left + (rect.width / 2)}px`;
                    
                    // 메뉴 표시
                    contextMenu.style.display = 'block';

                } else {
                    // 1-2. 텍스트 선택이 풀렸을 때
                    currentSelectionRange = null;
                    contextMenu.style.display = 'none';
                }
            }, 50);
        });

        // --- 2. [스포방지] 버튼 클릭 시 ---
        spoilerButton.addEventListener('click', () => {
            if (!currentSelectionRange) return;

            // <span> 요소를 생성
            const spoilerSpan = document.createElement('span');
            spoilerSpan.className = 'spoiler-mask';

            /**
             * [핵심] 접근성 처리 (Accessibility)
             * role="img" 와 aria-label 을 사용하면, 스크린 리더는
             * 이 태그 내부의 텍스트(스포일러 내용)를 무시하고
             * aria-label에 지정된 "스포방지"라는 텍스트만 읽어줍니다.
             */
            spoilerSpan.setAttribute('role', 'img');
            spoilerSpan.setAttribute('aria-label', '스포방지');

            try {
                // 선택된 텍스트를 <span>으로 감쌉니다.
                // (surroundContents 대신 extract/insert를 사용하면 더 안정적)
                const selectionContent = currentSelectionRange.extractContents();
                spoilerSpan.appendChild(selectionContent);
                currentSelectionRange.insertNode(spoilerSpan);
                
            } catch (e) {
                console.warn("스포일러 처리에 실패했습니다:", e);
            }

            // 처리 완료 후 메뉴 숨김 및 선택 해제
            contextMenu.style.display = 'none';
            currentSelectionRange = null;
            window.getSelection().removeAllRanges();
        });

        // --- 3. 회색 영역 더블탭 시 스포일러 해제 ---
        editor.addEventListener('dblclick', (event) => {
            const clickedElement = event.target;
            
            // 클릭된 요소가 .spoiler-mask 인지 확인
            if (clickedElement.classList.contains('spoiler-mask')) {
                // <span>을 제거하고 내부의 텍스트 노드로 교체
                const childNodes = Array.from(clickedElement.childNodes);
                clickedElement.replaceWith(...childNodes);
                
                // 더블탭 시 텍스트가 다시 선택되는 것을 방지
                event.preventDefault();
            }
        });

        // --- 4. (UX) 편집 영역이나 메뉴가 아닌 곳을 터치하면 메뉴 숨기기 ---
        document.addEventListener('touchstart', (event) => {
            if (!editor.contains(event.target) && !contextMenu.contains(event.target)) {
                contextMenu.style.display = 'none';
                currentSelectionRange = null;
                // window.getSelection().removeAllRanges(); // 선택은 유지시킬 수 있음
            }
        });

    </script>

</body>
</html>
