<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <!-- 모바일 화면 대응 (확대/축소 방지) -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>스포방지_테스트</title>
    <style>
        :root {
            --kakao-yellow: #FEE500;
            --system-gray: #f0f0f0;
            --system-dark-gray: #d0d0d0;
            --system-blue: #007bff;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            /* 모바일 기기의 뷰포트 전체 높이를 차지하도록 설정 */
            height: 100vh; 
            overflow: hidden; /* 스크롤 방지 */
            background-color: #A8C0D6; /* 카톡 채팅방 배경색을 body에 기본 적용 */
        }

        /* --- 메인 컨테이너 (이전 S23 시뮬레이터 래퍼) --- */
        /* 화면 크기에 맞춰 100%를 사용하도록 변경 */
        #device-simulator {
            width: 100%; 
            height: 100%; 
            margin: 0;
            border: none; /* 프레임 효과 제거 */
            border-radius: 0; /* 모서리 둥글게 처리 제거 */
            box-shadow: none; /* 그림자 효과 제거 */
            
            /* 레이아웃 구조는 유지: 세로 방향으로 요소 배치 */
            display: flex;
            flex-direction: column;
            overflow: hidden; 
            background-color: #A8C0D6; /* 카톡 채팅방 배경색 */
        }


        /* --- 상단 헤더 --- */
        header {
            background-color: #B2C7D9;
            padding: 12px 16px;
            text-align: center;
            font-weight: bold;
            font-size: 1.1rem;
            flex-shrink: 0; /* 높이 고정 */
        }

        /* --- 1. 채팅 메시지 영역 --- */
        #chat-log {
            flex-grow: 1; /* 남은 공간 모두 차지 */
            overflow-y: auto; /* 메시지 많아지면 스크롤 */
            padding: 16px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }

        .message-bubble {
            background-color: white;
            padding: 8px 12px;
            border-radius: 12px;
            max-width: 70%;
            word-wrap: break-word; /* 긴 텍스트 줄바꿈 */
            margin-bottom: 10px;
            font-size: 1rem;
            line-height: 1.5;
        }

        /* 내가 보낸 메시지 (오른쪽 정렬) */
        .message-bubble.sent {
            background-color: var(--kakao-yellow);
            align-self: flex-end; /* 오른쪽 정렬 */
            border-top-right-radius: 2px;
        }

        /* 다른 사람이 보낸 메시지 (왼쪽 정렬) */
        .message-bubble.received {
            background-color: white;
            align-self: flex-start;
            border-top-left-radius: 2px;
        }

        /* --- 2. 하단 입력 영역 --- */
        #input-area {
            display: flex;
            align-items: flex-end; /* 텍스트가 길어져도 버튼은 하단 유지 */
            padding: 8px 12px;
            background-color: white;
            border-top: 1px solid #ddd;
            flex-shrink: 0; /* 높이 고정 - 입력 영역이 항상 보이도록 보장 */
        }

        /* 텍스트 입력창 (contenteditable) */
        #text-editor {
            flex-grow: 1;
            min-height: 24px; /* 기본 한 줄 높이 */
            max-height: 100px; /* 최대 4-5줄 */
            overflow-y: auto;
            padding: 8px 12px;
            border: none;
            border-radius: 18px;
            background-color: var(--system-gray);
            font-size: 1rem;
            line-height: 1.5;
            -webkit-user-select: text;
            user-select: text;
            outline: none; /* 포커스 시 테두리 제거 */
        }
        
        /* 텍스트 입력창의 Placeholder */
        #text-editor:empty::before {
            content: "메시지 입력...";
            color: #999;
        }

        /* 전송 버튼 */
        #send-button {
            width: 40px;
            height: 40px;
            margin-left: 8px;
            padding: 0;
            border: none;
            border-radius: 50%;
            background-color: var(--system-blue);
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
            cursor: pointer;
            flex-shrink: 0;
            -webkit-tap-highlight-color: transparent;
        }
        #send-button:active {
            filter: brightness(0.9);
        }

        /* --- 3. 스포일러 마스크 스타일 --- */
        .spoiler-mask {
            background-color: var(--system-dark-gray);
            color: var(--system-dark-gray);
            border-radius: 4px;
            padding: 0 2px;
            -webkit-user-select: none; /* 더블탭 시 선택 방지 */
            user-select: none;
        }

        /* --- 4. 스포방지 툴팁 (컨텍스트 메뉴) --- */
        #context-menu {
            display: none;
            position: absolute;
            background-color: #333;
            border-radius: 6px;
            padding: 4px;
            z-index: 101; /* 다른 요소 위에 표시 */
            /* 입력 영역 위 중앙에 위치하도록 CSS 조정 */
            left: 50%;
            transform: translateX(-50%); 
            /* top은 JS에서 입력 영역 위치를 기준으로 설정할 것임 */
            -webkit-tap-highlight-color: transparent;
        }

        #spoiler-button {
            background: none;
            border: none;
            color: white;
            font-size: 0.9rem;
            font-weight: 500;
            padding: 8px 12px;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <!-- 메인 컨테이너 시작 (모바일 뷰포트 전체 사용) -->
    <div id="device-simulator">

        <header>채팅방</header>

        <!-- 채팅 메시지가 표시될 영역 -->
        <div id="chat-log">
            <div class="message-bubble received">
                <p>안녕하세요! 스포일러 기능 테스트입니다.</p>
                <p>아래 입력창에 글을 쓰고, 숨기고 싶은 부분을 드래그한 뒤 [스포방지] 버튼을 눌러보세요.</p>
            </div>
        </div>

        <!-- 하단 입력창 영역 -->
        <div id="input-area">
            <!-- 텍스트 입력은 이 div에서 합니다 -->
            <div id="text-editor" contenteditable="true" spellcheck="false"></div>
            <!-- 전송 버튼 -->
            <button id="send-button" aria-label="전송">↑</button>
        </div>

    </div>
    <!-- 메인 컨테이너 끝 -->


    <!-- 숨겨진 스포방지 툴팁 (body의 자식으로 유지) -->
    <div id="context-menu">
        <button id="spoiler-button">스포방지</button>
    </div>

    <script>
        // --- DOM 요소 가져오기 ---
        const editor = document.getElementById('text-editor');
        const sendButton = document.getElementById('send-button');
        const chatLog = document.getElementById('chat-log');
        const contextMenu = document.getElementById('context-menu');
        const spoilerButton = document.getElementById('spoiler-button');
        const inputArea = document.getElementById('input-area'); // 입력 영역 요소 추가

        // 현재 사용자가 선택한 텍스트의 '범위(Range)'를 저장할 변수
        let currentSelectionRange = null;

        // --- 1. (입력창) 텍스트 선택 완료 시 (손가락 뗄 때) 툴팁 표시 ---
        editor.addEventListener('touchend', (e) => {
            // 키보드가 올라오는 등의 이벤트를 방지하기 위해 터치만 확인
            if (e.touches.length > 0) return; 

            // selection 상태가 확정될 때까지 잠시 대기
            setTimeout(() => {
                const selection = window.getSelection();

                // 텍스트가 실제로 '선택'되었을 때
                if (selection && !selection.isCollapsed && selection.rangeCount > 0) {
                    currentSelectionRange = selection.getRangeAt(0).cloneRange();
                    
                    // --- 위치 수정: 입력 영역 바로 위 중앙에 표시 ---
                    const inputRect = inputArea.getBoundingClientRect();
                    
                    // 툴팁의 대략적인 높이 (패딩 포함 40px 정도로 가정)
                    // 실제 툴팁 높이를 가져올 수 없으므로(display: none 상태), 대략적인 값 사용
                    const menuHeight = 40; 
                    const margin = 8;
                    
                    // 입력 영역의 top 위치에서 툴팁 높이 + 마진 만큼 위로 설정
                    contextMenu.style.top = `${inputRect.top - menuHeight - margin}px`;
                    contextMenu.style.display = 'block';
                    // --- 위치 수정 끝 ---
                    
                } else {
                    // 텍스트 선택이 풀렸을 때
                    currentSelectionRange = null;
                    contextMenu.style.display = 'none';
                }
            }, 50); // 50ms 대기
        });

        // --- 2. [스포방지] 툴팁 버튼 클릭 시 ---
        spoilerButton.addEventListener('click', () => {
            if (!currentSelectionRange) return;

            // <span> 요소를 생성
            const spoilerSpan = document.createElement('span');
            spoilerSpan.className = 'spoiler-mask';

            /**
             * [핵심] 접근성 처리 (VoiceOver/TalkBack)
             * role="img" 와 aria-label 을 사용하면, 스크린 리더는
             * 이 태그 내부의 텍스트(스포일러 내용)를 무시하고
             * aria-label에 지정된 "스포방지"라는 텍스트만 읽어줍니다.
             * (role="img"는 이 요소가 그래픽 요소임을 알려줍니다)
             */
            spoilerSpan.setAttribute('role', 'img');
            spoilerSpan.setAttribute('aria-label', '스포방지');

            try {
                // 선택된 텍스트를 <span>으로 감쌉니다.
                const selectionContent = currentSelectionRange.extractContents();
                spoilerSpan.appendChild(selectionContent);
                currentSelectionRange.insertNode(spoilerSpan);
                
            } catch (e) {
                console.warn("스포일러 처리에 실패했습니다:", e);
            }

            // 처리 완료 후 메뉴 숨김 및 선택 해제
            contextMenu.style.display = 'none';
            currentSelectionRange = null;
            window.getSelection().removeAllRanges();
            editor.focus(); // 편집기에 다시 포커스
        });

        // --- 3. [전송] 버튼 클릭 시 ---
        sendButton.addEventListener('click', () => {
            // 입력창의 HTML 내용을 그대로 가져옵니다.
            const messageHtml = editor.innerHTML.trim();

            if (messageHtml === "") {
                return; // 내용이 없으면 전송 안 함
            }

            // 새 메시지 버블 생성
            const messageBubble = document.createElement('div');
            messageBubble.className = 'message-bubble sent'; // 'sent' 클래스 추가
            messageBubble.innerHTML = messageHtml; // HTML을 그대로 삽입

            // 채팅 로그에 추가
            chatLog.appendChild(messageBubble);

            // 입력창 비우기
            editor.innerHTML = '';

            // 채팅창 스크롤을 맨 아래로 내리기
            chatLog.scrollTop = chatLog.scrollHeight;
        });

        // --- 4. 스포일러 해제 (더블탭) ---
        // 채팅 로그와 입력창 모두에서 동작하도록 document 전체에 이벤트 위임
        // **전송된 메시지에도 자동으로 적용됩니다.**
        document.body.addEventListener('dblclick', (event) => {
            // 이벤트가 발생한 요소 또는 그 부모 중에 .spoiler-mask 를 찾음
            const spoilerMask = event.target.closest('.spoiler-mask');
            
            if (spoilerMask) {
                // <span>을 제거하고 내부의 텍스트 노드로 교체
                const childNodes = Array.from(spoilerMask.childNodes);
                spoilerMask.replaceWith(...childNodes);
                
                event.preventDefault(); // 더블클릭 기본 동작(텍스트 선택 등) 방지
            }
        });

        // --- 5. (UX) 툴팁 외의 영역 터치 시 툴팁 숨기기 ---
        document.addEventListener('touchstart', (event) => {
            // 툴팁이나 편집기 내부를 터치한 게 아니라면
            if (!contextMenu.contains(event.target) && !editor.contains(event.target)) {
                contextMenu.style.display = 'none';
            }
        });

    </script>

</body>
</html>
